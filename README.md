# [aws-lambda-layer-kubectl](#jenkins)

This repo intends to be used as a lambda custom runtime for updating an eks cluster from a lambda.

## **Project structure and usage**

It's composed by:

- **Dockerfile** 
    
    It's a Dockerfile using multi-stage builds in which contains 2 stages: builder and runtime. Lambda is composed of a runtime and an execution context. 

    The builder stage is responsible for installing kubectl, aws cli and helm binaries to be used from the Lambda itself.

    The runtime stage is responsible for creating a provided lambda runtime in which will be present the binaries installed from the builder stage.

    It can be generated by running the following command:
    ```bash
    #!/bin/bash
    export DOCKER_REPOSITORY=renaalve
    export DOCKER_IMAGE=aws-lambda-layer-kubectl
    export DOCKER_IMAGE_TAG=latest

    docker build -f Dockerfile -t ${DOCKER_REPOSITORY}/${IMAGE_NAME}:${IMAGE_TAG} .
    ``` 
    
    This image will be responsible for generating the respective lambda layer intended. It will generate a **zip** file on `/root/lambda-layer.zip`. 

    Run the following command to get the lambda layer and use it to create a new lambda layer on AWS Console:
    ```bash
    #!/bin/bash
    export DOCKER_REPOSITORY=renaalve
    export DOCKER_IMAGE=aws-lambda-layer-kubectl
    export DOCKER_IMAGE_TAG=latest

    docker cp $(docker run -d ${DOCKER_REPOSITORY}/${IMAGE_NAME}:${IMAGE_TAG}):/root/lambda-layer.zip .
    ``` 

- **deploy.sh** 

    Bash file in which contains some choices to build and deploy the lambda itself. It's composed by these cases:

    `build-layer`: It creates the **lambda-layer.zip** file. To do this, run:
    ```bash
    #!/bin/bash
    ./deploy.sh build-layer
    ``` 

    `deploy-layer`: It deploys the lambda layer on AWS to be used by lambda. To do this, run:
    ```bash
    #!/bin/bash
    ./deploy.sh build-layer
    ``` 

    `deploy-lambda`: Before you execute this, you must replace `LambdaLayerARN` parameter by the lambda layer arn generated from deploy-layer command. After that, deploy lambda by running:
    ```bash
    #!/bin/bash
    ./deploy.sh deploy-lambda
    ``` 

- **template.yaml and template-layer.yaml**  

    SAM templates for lambda layer and lambda itself respectively.